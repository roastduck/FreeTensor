<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Automatic Differentiation - FreeTensor</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Automatic Differentiation";
        var mkdocs_page_input_path = "guide/ad.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> FreeTensor
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">GitHub</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="https://github.com/roastduck/FreeTensor">FreeTensor</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">User Guide</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../">Get Started</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build-and-run/">Build and Run</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../first-program/">Your First Program with FreeTenor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../schedules/">Optimize a Program with Schedules</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gpu/">Running on a GPU</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Automatic Differentiation</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#reverse-mode-ad">Reverse-Mode AD</a>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/">Python API</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">FreeTensor</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>User Guide &raquo;</li><li>Automatic Differentiation</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="automatic-differentiation">Automatic Differentiation</h1>
<p>Automatic Differentiation (AD) transforms a program to another program that computes the original one's derivative or gradient. FreeTensor supports Reverse-Mode AD, and there is a plan to support Forward-Mode AD in the future.</p>
<h2 id="reverse-mode-ad">Reverse-Mode AD</h2>
<p>Suppose there is a program <code>x -&gt; y -&gt; z -&gt; w</code> that computes an output <code>w</code> from intermediate variables <code>z</code> and <code>y</code>, and an input variable <code>x</code>. Reverse-Mode AD generates a gradient program <code>dw/dw=1 -&gt; dw/dz -&gt; dw/dy -&gt; dw/dx</code> that computes <code>dw/dx</code> by Chain Rule. <code>y</code>, <code>z</code> and <code>w</code> may be saved in a "tape" when evaluation the original program, to be reused in the gradient one.</p>
<p>Here is an example of Reverse-Mode AD in FreeTensor:</p>
<pre><code class="language-python">import freetensor as ft
import numpy as np

n = 4

def test(a: ft.Var[(n,), &quot;float32&quot;], b: ft.Var[(n,), &quot;float32&quot;]):
    y = ft.zeros((), &quot;float32&quot;)
    for i in range(n):
        y[()] += a[i] * b[i]
    return y

fwd, bwd, input_grads, output_grads = ft.grad(test, ['a', 'b'],
                                              [ft.Return()])
fwd = ft.optimize(fwd)
bwd = ft.optimize(bwd)

a = np.array([0, 1, 2, 3], dtype=&quot;float32&quot;)
b = np.array([3, 2, 1, 0], dtype=&quot;float32&quot;)
y = fwd(a, b)
print(y.numpy())
dzdy = np.array(1, dtype='float32')
dzda, dzdb = bwd(**{output_grads[ft.Return()]: dzdy})[input_grads['a'],
                                                      input_grads['b']]
print(dzda.numpy())
print(dzdb.numpy())
</code></pre>
<p>You need to call <a href="../../api/#freetensor.core.autograd.grad"><code>ft.grad</code></a> (or the inplace version <a href="../../api/#freetensor.core.autograd.grad_"><code>ft.grad_</code></a>) to generate a <em>forward</em> function and a <em>backward</em> function. Please note that the forward function <code>fwd</code> is not the same as the original function <code>test</code>, because <code>fwd</code> may save some intermediate tensors to a global <code>tape</code>, and <code>fwd</code> must be executed before the backward one <code>bwd</code>.</p>
<p>After that, you call <code>ft.optimize</code> to optimize and compile the program just as in previous examples, but for both <code>fwd</code> and <code>bwd</code> this time.</p>
<p>Finally, you execute <code>fwd</code> and <code>bwd</code>. The parameters and return values of <code>bwd</code> are the gradients of <code>a</code>, <code>b</code> and <code>y</code>, which have their own names. To set and get these parameters and return values, you look up for them in two dictionaries <code>input_grads</code> and <code>output_grads</code> returned from <code>ft.grad</code> (in type <a href="../../api/#freetensor.core.autograd.ArgRetDict"><code>ft.ArgRetDict</code></a>. <code>input_grads</code> and <code>output_grads</code> accept either a name of a parameter, or a special <a href="../../api/#freetensor.core.autograd.Return"><code>ft.Return</code></a> to specify a return value. When invoking <code>bwd</code>, parameters can be set via keyword arguments, and return values can be collect via a bracket (from a special type <a href="../../api/#freetensor.core.driver.ReturnValuesPack"><code>ft.ReturnValuesPack</code></a>.</p>
<p>Intermediate variables are not always have to be saved to the "tape" from the forward function. If a variable is need in the backward function but not saved, it will be re-computed, which is sometimes even faster than saving it due to better locality. By default, FreeTensor uses heuristics to determine which variable to save. To get better performance, you may want to control which intermediate variables should be saved by setting an optional <code>tapes</code> parameter in <code>ft.grad</code>. <code>tapes</code> can either be a different mode, or a explicit list of AST node IDs of all <code>VarDef</code> nodes of the variables you want to save.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../gpu/" class="btn btn-neutral float-left" title="Running on a GPU"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../api/" class="btn btn-neutral float-right" title="Python API">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../gpu/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../api/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
        with:
          ssh-key: ${{ secrets.CI }}
          submodules: true
          fetch-depth: 0
      - name: Load environment
        run: |
          source /opt/spack/share/spack/setup-env.sh
          spack load gcc@8.4.0
          spack load cuda@10.2.89
          spack load python@3.8.6
          spack load py-pip@20.2
          spack load cudnn@8.0.4.30-10.2-linux-x64
          spack load cmake@3.18.4%gcc@7.5.0
          spack load intel-mkl@2020.3.279
          echo "PATH=$PATH" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH" >> $GITHUB_ENV
      - name: Build ffi module in Release
        run: |
          rm -rf build
          mkdir build
          cmake -B build -S . -DCMAKE_CXX_COMPILER=/mnt/ssd/spack/opt/spack/linux-ubuntu16.04-haswell/gcc-7.3.0/gcc-8.4.0-wxwjau3zh2vgh3gbw56byro6skfjuhkz/bin/g++ -DCMAKE_C_COMPILER=/mnt/ssd/spack/opt/spack/linux-ubuntu16.04-haswell/gcc-7.3.0/gcc-8.4.0-wxwjau3zh2vgh3gbw56byro6skfjuhkz/bin/gcc -DCMAKE_BUILD_TYPE=Release -DWITH_MKL=/mnt/ssd/spack/opt/spack/linux-ubuntu16.04-haswell/gcc-7.3.0/intel-mkl-2020.3.279-ejepo2yk7ihi5tcmg7s4fqne7l7u4fgk/mkl
          cmake --build build -j
      - name: Run PyTest
        run: env PYTHONPATH=build:python pytest -s test
